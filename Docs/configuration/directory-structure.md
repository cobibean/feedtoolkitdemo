# Directory Structure & Execution Context

> **Critical Concept** â€” Understanding where to run commands is essential. Most "command not found" errors come from running commands in the wrong directory.

---

## The Critical Rule

```bash
# âŒ WRONG â€” Most commands won't work from here
cd flare-custom-feeds-toolkit
npm run dev  # â† Error: script not found

# âœ… CORRECT â€” Frontend commands must run from frontend/
cd flare-custom-feeds-toolkit/frontend
npm run dev  # â† Works!
```

**TL;DR:** The toolkit has two execution contexts â€” **root** (for contracts/bot) and **frontend/** (for web UI).

---

## Project Structure Overview

```
flare-custom-feeds-toolkit/           â† Repo root
â”‚
â”œâ”€â”€ .env                              â† Root environment variables (optional)
â”œâ”€â”€ package.json                      â† Root dependencies (bot, Hardhat)
â”œâ”€â”€ hardhat.config.cjs                â† Hardhat configuration
â”‚
â”œâ”€â”€ contracts/                        â† Solidity smart contracts
â”‚   â”œâ”€â”€ PriceRecorder.sol
â”‚   â”œâ”€â”€ PoolPriceCustomFeed.sol
â”‚   â”œâ”€â”€ CrossChainPoolPriceCustomFeed.sol
â”‚   â”œâ”€â”€ PriceRelay.sol
â”‚   â””â”€â”€ MockFdcVerification.sol
â”‚
â”œâ”€â”€ scripts/                          â† Deployment scripts (run from root)
â”‚   â”œâ”€â”€ deploy-price-recorder.js
â”‚   â”œâ”€â”€ deploy-custom-feed.js
â”‚   â”œâ”€â”€ deploy-crosschain-eth-to-flare.js
â”‚   â”œâ”€â”€ enable-pool.js
â”‚   â””â”€â”€ test-*.js
â”‚
â”œâ”€â”€ src/                              â† Standalone bot (run from root)
â”‚   â”œâ”€â”€ custom-feeds-bot.js
â”‚   â””â”€â”€ fdc-client.js
â”‚
â”œâ”€â”€ test/                             â† Contract tests
â”‚   â”œâ”€â”€ CrossChainPoolPriceCustomFeed.test.cjs
â”‚   â””â”€â”€ PriceRelay.test.cjs
â”‚
â”œâ”€â”€ artifacts/                        â† âš ï¸ Generated by Hardhat (do not edit)
â”‚   â””â”€â”€ contracts/
â”‚       â””â”€â”€ *.json                    â† Compiled contract ABIs + bytecode
â”‚
â”œâ”€â”€ cache/                            â† âš ï¸ Hardhat cache (can delete safely)
â”‚
â”œâ”€â”€ logs/                             â† âš ï¸ Bot log files (generated at runtime)
â”‚   â””â”€â”€ bot-YYYY-MM-DD.jsonl
â”‚
â”œâ”€â”€ Docs/                             â† Documentation (you are here)
â”‚   â”œâ”€â”€ configuration/
â”‚   â”œâ”€â”€ getting-started/
â”‚   â”œâ”€â”€ deployment/
â”‚   â”œâ”€â”€ operations/
â”‚   â””â”€â”€ reference/
â”‚
â””â”€â”€ frontend/                         â† ğŸŒ Next.js web application
    â”œâ”€â”€ .env                          â† Frontend environment variables
    â”œâ”€â”€ package.json                  â† Frontend dependencies
    â”œâ”€â”€ next.config.ts                â† Next.js configuration
    â”‚
    â”œâ”€â”€ data/                         â† ğŸ’¾ Local JSON storage
    â”‚   â”œâ”€â”€ feeds.json                â† Your deployed feeds (auto-generated)
    â”‚   â””â”€â”€ feeds.template.json       â† Template for new installs
    â”‚
    â”œâ”€â”€ public/                       â† Static assets
    â”‚   â”œâ”€â”€ brand/                    â† Logo, fonts, branding
    â”‚   â””â”€â”€ chain-icons/              â† Chain logo images
    â”‚
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ app/                      â† Next.js App Router (pages)
    â”‚   â”‚   â”œâ”€â”€ page.tsx              â† Landing page (/)
    â”‚   â”‚   â”œâ”€â”€ layout.tsx            â† Root layout
    â”‚   â”‚   â”œâ”€â”€ globals.css           â† Global styles
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ dashboard/            â† Protected dashboard routes
    â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx        â† Dashboard layout (sidebar)
    â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          â† Dashboard home
    â”‚   â”‚   â”‚   â”œâ”€â”€ deploy/           â† Deploy contracts
    â”‚   â”‚   â”‚   â”œâ”€â”€ monitor/          â† Monitor feeds
    â”‚   â”‚   â”‚   â”œâ”€â”€ bot/              â† In-browser bot control
    â”‚   â”‚   â”‚   â”œâ”€â”€ settings/         â† Settings & bot config export
    â”‚   â”‚   â”‚   â””â”€â”€ verify/           â† Contract verification
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ api/                  â† API routes (backend)
    â”‚   â”‚       â”œâ”€â”€ feeds/            â† CRUD for feeds.json
    â”‚   â”‚       â”œâ”€â”€ fdc/              â† FDC API proxy (CORS bypass)
    â”‚   â”‚       â”œâ”€â”€ bot/              â† Bot control endpoints
    â”‚   â”‚       â”œâ”€â”€ relay/            â† Relay chain price fetching
    â”‚   â”‚       â””â”€â”€ cleanup/          â† Cleanup utilities
    â”‚   â”‚
    â”‚   â”œâ”€â”€ components/               â† React components
    â”‚   â”‚   â”œâ”€â”€ chain/                â† Chain selector
    â”‚   â”‚   â”œâ”€â”€ layout/               â† Header, sidebar, theme
    â”‚   â”‚   â””â”€â”€ ui/                   â† shadcn/ui components
    â”‚   â”‚
    â”‚   â”œâ”€â”€ hooks/                    â† Custom React hooks
    â”‚   â”‚   â”œâ”€â”€ use-pool-info.ts      â† Auto-detect pool info
    â”‚   â”‚   â”œâ”€â”€ use-feed-updater.ts   â† FDC attestation workflow
    â”‚   â”‚   â””â”€â”€ use-bot.ts            â† In-browser bot state
    â”‚   â”‚
    â”‚   â”œâ”€â”€ lib/                      â† Utilities & configuration
    â”‚   â”‚   â”œâ”€â”€ artifacts/            â† Bundled contract ABIs
    â”‚   â”‚   â”œâ”€â”€ chains.ts             â† Multi-chain config
    â”‚   â”‚   â”œâ”€â”€ contracts.ts          â† Contract interfaces
    â”‚   â”‚   â”œâ”€â”€ wagmi-config.ts       â† Wallet configuration
    â”‚   â”‚   â”œâ”€â”€ types.ts              â† TypeScript types
    â”‚   â”‚   â”œâ”€â”€ utils.ts              â† Utility functions
    â”‚   â”‚   â””â”€â”€ priceSources/         â† Price source implementations
    â”‚   â”‚
    â”‚   â””â”€â”€ context/                  â† React Context providers
    â”‚       â”œâ”€â”€ feeds-context.tsx     â† Global feeds state
    â”‚       â””â”€â”€ storage-mode-context.tsx
    â”‚
    â”œâ”€â”€ .next/                        â† âš ï¸ Next.js build output (generated)
    â””â”€â”€ node_modules/                 â† âš ï¸ Frontend dependencies (generated)
```

---

## Execution Context Table

| Task | Run From | Command | Why |
|------|----------|---------|-----|
| **Start web UI** | `frontend/` | `npm run dev` | Next.js project root |
| **Build web UI** | `frontend/` | `npm run build` | Next.js build command |
| **Deploy contracts (CLI)** | root | `npx hardhat run scripts/deploy-*.js` | Hardhat config at root |
| **Run bot** | root | `npm run bot:start` | Bot code at `src/` |
| **Compile contracts** | root | `npx hardhat compile` | Hardhat config at root |
| **Run tests** | root | `npx hardhat test` | Test files at root |
| **Install root deps** | root | `npm install` | Root `package.json` |
| **Install frontend deps** | `frontend/` | `npm install` | Frontend `package.json` |

---

## Common Mistakes & Fixes

### Mistake #1: Running frontend commands from root

```bash
# âŒ WRONG
cd flare-custom-feeds-toolkit
npm run dev
# Error: Missing script: "dev"

# âœ… CORRECT
cd flare-custom-feeds-toolkit/frontend
npm run dev
# âœ“ Next.js starts at http://localhost:3000
```

**Why:** The root `package.json` doesn't have a `dev` script â€” only the frontend does.

---

### Mistake #2: Running Hardhat from frontend

```bash
# âŒ WRONG
cd frontend
npx hardhat compile
# Error: HH1: Hardhat was set up to use the hardhat config file at...

# âœ… CORRECT
cd ..  # Go back to root
npx hardhat compile
# âœ“ Compiling contracts...
```

**Why:** `hardhat.config.cjs` is at the root, not in `frontend/`.

---

### Mistake #3: Wrong node_modules

```bash
# âŒ WRONG â€” Installing frontend deps at root
cd flare-custom-feeds-toolkit
npm install @rainbow-me/rainbowkit
# Installs to root node_modules (wrong place!)

# âœ… CORRECT â€” Install frontend deps in frontend/
cd frontend
npm install @rainbow-me/rainbowkit
# Installs to frontend/node_modules âœ“
```

**Why:** Frontend dependencies belong in `frontend/node_modules`. The root has separate dependencies for Hardhat and the bot.

---

### Mistake #4: Assuming .env is shared

```bash
# Many users think there's only ONE .env file

# Reality: TWO separate .env locations
flare-custom-feeds-toolkit/.env          â† Root .env (Hardhat, bot)
flare-custom-feeds-toolkit/frontend/.env â† Frontend .env (Next.js)
```

**Rule of thumb:**
- If running from **root** â†’ uses root `.env` (fallback to `frontend/.env`)
- If running from **frontend/** â†’ uses `frontend/.env` only

See [Environment Variables Guide](./environment-variables.md) for details.

---

## Build Artifacts & Generated Files

### Do NOT Edit Manually

```
artifacts/          â† Generated by: npx hardhat compile
cache/              â† Generated by: npx hardhat compile
frontend/.next/     â† Generated by: npm run build (in frontend)
logs/               â† Generated by: bot at runtime
```

**Safe to delete:** All these directories can be regenerated.

```bash
# Clean build artifacts
rm -rf artifacts cache
npx hardhat compile  # Regenerates

# Clean Next.js build
cd frontend
rm -rf .next
npm run build  # Regenerates
```

---

### Always in Git

```
contracts/          â† Source Solidity files
scripts/            â† Deployment scripts
src/                â† Bot source code
frontend/src/       â† Frontend source code
frontend/public/    â† Static assets
```

---

### Sometimes in Git

```
frontend/data/feeds.json  â† Can commit for self-hosted setups
                            Do NOT commit for public repos (contains addresses)
```

**Recommendation:**
- **Private repos:** Commit `feeds.json` as backup
- **Public repos:** Add to `.gitignore`, use `feeds.template.json`

---

## Installation Order

When setting up a fresh clone:

```bash
# 1. Install root dependencies (Hardhat, bot)
cd flare-custom-feeds-toolkit
npm install

# 2. Install frontend dependencies (Next.js, React)
cd frontend
npm install

# 3. Set up environment variables
cp .env.example .env  # Edit with your private key

# 4. (Optional) Compile contracts
cd ..
npx hardhat compile
```

---

## Data Persistence Locations

### Local JSON Storage (Default)

```
frontend/data/feeds.json  â† All deployed feeds, recorders, relays
```

**Characteristics:**
- Persists across restarts (file-based)
- Single source of truth
- Lost if you delete the file (keep backups!)
- Not suitable for Vercel (filesystem is ephemeral)

**Backup:**
```bash
# From repo root
cp frontend/data/feeds.json frontend/data/feeds.backup.json

# Or export from UI: Settings â†’ Export Config
```

---

### Supabase Storage (Optional)

```
External database (PostgreSQL)
```

**Characteristics:**
- Persists across deployments
- Suitable for Vercel
- Multi-user capable
- Requires Supabase account

**Setup:** See [Storage Modes](../FEED_STORAGE_LOCAL_MODE.md)

---

## Log Files

### Bot Logs

```
logs/bot-2025-12-13.jsonl  â† JSON Lines format (one JSON object per line)
```

**Generated by:** Standalone bot (`npm run bot:start`)

**Location:** Root `logs/` directory (configurable via `BOT_LOG_FILE_DIR`)

**Format:**
```json
{"timestamp":"2025-12-13T10:30:00.000Z","level":"info","message":"Bot started","feeds":2}
{"timestamp":"2025-12-13T10:31:00.000Z","level":"success","feed":"FXRP_USDTO","action":"update"}
```

**Analyzing logs:**
```bash
# View latest log file
tail -f logs/bot-*.jsonl

# Parse JSON logs with jq
cat logs/bot-2025-12-13.jsonl | jq '.message'

# Filter errors only
cat logs/bot-2025-12-13.jsonl | jq 'select(.level=="error")'
```

---

### Frontend Logs

Frontend logs appear in:
1. **Browser console** (F12 â†’ Console tab)
2. **Server terminal** (where you ran `npm run dev`)

**No log files generated** â€” use browser DevTools to capture.

---

## Port Usage

| Service | Default Port | Configurable |
|---------|--------------|--------------|
| Frontend dev server | 3000 | `PORT=3001 npm run dev` |
| Hardhat node (testing) | 8545 | `hardhat.config.cjs` |

**Check if port is in use:**
```bash
# macOS/Linux
lsof -i :3000

# Kill process on port
kill -9 $(lsof -t -i:3000)
```

---

## Filesystem Permissions

### Common Issues

**"EACCES: permission denied"** when writing `feeds.json`:

```bash
# Check permissions
ls -la frontend/data/feeds.json

# Fix ownership (macOS/Linux)
sudo chown $USER:$USER frontend/data/feeds.json
chmod 644 frontend/data/feeds.json
```

**"Cannot find module"** after `npm install`:

```bash
# Ensure you ran npm install in the correct directory
cd frontend
npm install  # â† Did you run this?

# Check node_modules exists
ls frontend/node_modules  # Should list many packages
```

---

## Working with Multiple Environments

### Development vs Production Setup

```
project/
â”œâ”€â”€ flare-custom-feeds-toolkit/        â† Production (main branch)
â”‚   â”œâ”€â”€ .env                           â† Production keys
â”‚   â””â”€â”€ frontend/data/feeds.json       â† Production feeds
â”‚
â””â”€â”€ flare-custom-feeds-toolkit-dev/    â† Development (dev branch)
    â”œâ”€â”€ .env                           â† Testnet keys
    â””â”€â”€ frontend/data/feeds.json       â† Testnet feeds
```

**Benefit:** Never accidentally deploy to mainnet from dev environment.

---

## Quick Reference Commands

```bash
# === FROM ROOT ===
npm install                    # Install root deps
npm run bot:start              # Start standalone bot
npx hardhat compile            # Compile contracts
npx hardhat run scripts/deploy-price-recorder.js --network flare
npx hardhat test               # Run contract tests

# === FROM FRONTEND/ ===
npm install                    # Install frontend deps
npm run dev                    # Start dev server (localhost:3000)
npm run build                  # Build for production
npm run start                  # Start production server
npm run lint                   # Run ESLint

# === NAVIGATION ===
cd frontend                    # Go to frontend
cd ..                          # Go back to root
pwd                            # Print current directory
```

---

## Troubleshooting

### "Command not found: npm"

**Solution:** Install Node.js from [nodejs.org](https://nodejs.org/) (v18 or higher)

```bash
# Verify installation
node --version   # Should print v18.x.x or higher
npm --version    # Should print 9.x.x or higher
```

---

### "Module not found" errors

**Symptoms:**
```
Error: Cannot find module '@rainbow-me/rainbowkit'
```

**Solution:** Install dependencies in the correct directory

```bash
# If error is in FRONTEND code
cd frontend
npm install

# If error is in BOT/HARDHAT code
cd ..  # Go to root
npm install
```

---

### "Script 'dev' not found"

**Symptom:**
```
npm ERR! missing script: dev
```

**Solution:** You're in the wrong directory

```bash
# Check where you are
pwd

# Should be: /path/to/flare-custom-feeds-toolkit/frontend
# If not, navigate there:
cd frontend
npm run dev
```

---

### "Hardhat config not found"

**Symptom:**
```
HH8: There's a Hardhat config file at /Users/.../frontend/hardhat.config.cjs
but Hardhat was run from /Users/.../frontend/
```

**Solution:** Run Hardhat from root, not frontend

```bash
cd ..  # Go to repo root
npx hardhat compile
```

---

## Related Documentation

- [Environment Variables Guide](./environment-variables.md) â€” Complete .env reference
- [Supported Chains Reference](./supported-chains.md) â€” Chain IDs and networks
- [Getting Started](../getting-started/01-installation.md) â€” Initial setup
- [Bot Configuration](../operations/bot-configuration.md) â€” Running the bot

---

## Cheat Sheet

```bash
# Where am I?
pwd

# What can I run here?
ls package.json && cat package.json | grep '"scripts"' -A 10

# Root directory marker files:
hardhat.config.cjs
src/custom-feeds-bot.js

# Frontend directory marker files:
next.config.ts
src/app/layout.tsx
```

**Golden rule:** When in doubt, check `package.json` scripts to see what commands are available in your current directory.

